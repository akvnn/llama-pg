name: Build, Push Docker & Helm Chart Release

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  REGISTRY: docker.io 
  IMAGE_PREFIX: akvn

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space Before Build
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from release
        id: meta
        run: |
          # Use release tag or generate from commit SHA
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend 
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-frontend:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Prune between builds
        run: docker system prune -f
        
      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-api:${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-charts:
    needs: build-and-push
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Update Helm Chart values
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          CHART_PATH="k8s/charts/llama-pg"
          
          # Update subchart image tags
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/charts/api/values.yaml
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/charts/worker/values.yaml

          # Update frontend image tag
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/values.yaml
          
          # Update subchart versions and appVersions
          CHART_VERSION="${VERSION#v}"
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/charts/api/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/charts/api/Chart.yaml
          
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/charts/worker/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/charts/worker/Chart.yaml

          # Update dependency versions in main chart
          sed -i "/name: api/,/version:/ s|version: \".*\"|version: \"${CHART_VERSION}\"|" ${CHART_PATH}/Chart.yaml
          sed -i "/name: worker/,/version:/ s|version: \".*\"|version: \"${CHART_VERSION}\"|" ${CHART_PATH}/Chart.yaml

          # Update main chart version and appVersion
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/Chart.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump helm charts to version ${{ needs.build-and-push.outputs.version }}"
          title: "chore: bump helm charts to version ${{ needs.build-and-push.outputs.version }}"
          body: |
            ## Helm Chart Version Update
            
            This PR updates the Helm chart versions and image tags to `${{ needs.build-and-push.outputs.version }}`.
            
            ### Changes:
            - Updated image tags in values.yaml files
            - Updated chart versions in Chart.yaml files
            - Updated appVersion in Chart.yaml files
            
            ### Docker Images Published:
            - `${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-frontend:${{ needs.build-and-push.outputs.version }}`
            - `${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/llama-pg-api:${{ needs.build-and-push.outputs.version }}`
            
            **Auto-generated by release workflow**
          branch: helm-chart-update-${{ needs.build-and-push.outputs.version }}
          base: main
          delete-branch: true

  helm-release:
    needs: build-and-push
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Update Helm Chart values
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          CHART_PATH="k8s/charts/llama-pg"
          
          # Update subchart image tags
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/charts/api/values.yaml
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/charts/worker/values.yaml

          # Update frontend image tag
          sed -i "0,/tag: \"\"/{s|tag: \"\".*|tag: \"${VERSION}\"|}" ${CHART_PATH}/values.yaml
          
          # Update subchart versions and appVersions
          CHART_VERSION="${VERSION#v}"
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/charts/api/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/charts/api/Chart.yaml
          
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/charts/worker/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/charts/worker/Chart.yaml

          sed -i "/name: api/,/version:/ s|version: \".*\"|version: \"${CHART_VERSION}\"|" ${CHART_PATH}/Chart.yaml
          sed -i "/name: worker/,/version:/ s|version: \".*\"|version: \"${CHART_VERSION}\"|" ${CHART_PATH}/Chart.yaml

          # Update main chart version and appVersion
          sed -i "s|^version:.*|version: ${CHART_VERSION}|g" ${CHART_PATH}/Chart.yaml
          sed -i "s|^appVersion:.*|appVersion: \"${VERSION}\"|g" ${CHART_PATH}/Chart.yaml

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Update Helm dependencies
        run: |
          CHART_PATH="k8s/charts/llama-pg"
          helm dependency update ${CHART_PATH}

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: true
        with:
          charts_dir: k8s/charts